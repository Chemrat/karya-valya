Message structure:
[header][body]

Header structure:
[body size][message type]
Body size and message type is 4 bytes variables (it means that the header size is 8 bytes).

Body structure:
Json

Examples:

System type:

[[0x00000031][0x00000001]]
[{"login" : "retard", "password" : "iamnotretard"}]

[[0x00000031][0x00000001]]
[{"url_to_upload_map" : "grief.ly/FFFFFFFFFFFFFFFF"}]

[[0x00000035][0x00000001]]
[{"url_to_download_map" : "grief.ly/FFFFFFFFFFFFFFFF"}]


Ordinary typa (aka keyboard type):
[[0x0000001C][0x00000002]]
[{"id" : 1, "key" : "KEY_UP"}]

[[0x00000020][0x00000002]]
[{"id" : 0, "key" : "CREATE_NEW"}]

Message type:
[[0x00000032][0x00000003]]
[{"id" : 1, "type" : "OOC", "text" : "Hello world"}]


PROTOCOL:

I. LOGIN STAGE

1. from CLIENT to SERVER:
protocol version, 4 bytes ("S132")

2. from CLIENT to SERVER
type: 1 (SYSTEM)
{"login" : "Someone", "password" : "12345", "game_version" : "v0.2.1"}

3.
(It is better to check game version first always)
b) WRONG GAME VERSION
 from SERVER to CLIENT
type: 1 (SYSTEM)
{"result" : "game_version_error", "correct_game_version" : "v0.2.2"}
-> connection closed

a) WRONG LOGIN OR PASSWORD
 from SERVER to CLIENT
type: 1 (SYSTEM)
{"result" : "authentication_error"}
-> connection closed

c) MASTER CLIENT DOES NOT EXIST
 from SERVER to CLIENT
Server creates new client, gives number to him (number - NOT -1)
type: 1 (SYSTEM)
{"result" : "success", "map" : "no_map", "your_id" : 42}
New client now master client

d) MASTER CLIENT EXISTS AND "login" DOES NOT HAVE ID
Server creates new client, gives number to him (number - NOT -1)

 from SERVER to ALL CLIENTS
 type: 5 (NEW CLIENT)
 "id" - new number for new client
{"id" : 42}

 from SERVER to MASTER CLIENT
 type: 1 (SYSTEM)
{"url_to_upload_map" : "grief.ly/blah"}

 from SERVER to CLIENT
type: 1 (SYSTEM)
{"result" : "success", "map" : "grief.ly/blah", "your_id" : 42}

c) MASTER CLIENT EXISTS AND "login" DOES HAVE ID
Server uses existing client info, takes number from that info

 from SERVER to MASTER CLIENT
 type: 1 (SYSTEM)
{"url_to_upload_map" : "grief.ly/blah"}

 from SERVER to CLIENT
type: 1 (SYSTEM)
{"result" : "success", "map" : "grief.ly/blah", "your_id" : 24}

d) UNDEFINED ERROR
For example, during the process master client disconnects, or something else

 from SERVER to CLIENT
{"result" : "undefined_error"}

////////////////////////////////
END OF LOGIN STAGE

II. ACTIVE CONNECTION STAGE

No specific order

X - NOT 1 (X may be 2, 3, 4, etc)
In other words, if other action is not defined for this type of the message then server should broadcast the message

1. 

from CLIENT to SERVER
 type: X
{some json}

after that broadcast message

from SERVER to ALL CLIENTS (even inital client):
 type: X
{"id" : 42, some json}

2.

Each T milliseconds (now T is 100, 10 messages per second)

from SERVER to CLIENT
 type: 4 (NEW_TICK)
(empty)

///////////////
END OF ACTIVE CONNECTION STAGE

III. END CONNECTION STAGE

No special messages for finishing connection, server/client just close socket if it is needed.

IF CLIENT CLOSES HIS CONNECTION:

a) It is a regular client

Server should remove this client from the client list.
Note that when any new client will be created server should not reuse numbers for clients.
So we dont send to this client messages anymore, but we still keep information about it (login + number, maybe something
else later (ip?)).

b) It is master client, and there is at least one other client.

Make a) with master client, but make some client (in future here will be some heuristic probably) master client.
If master client happens during a new client connection - we do not care.
The master client disconnection should be really rare case

c) It is master client, and there is no any other clients.

Forget everything. Basically, restart server (well, at least do not keep information about logins + ids)

































